---
- name: Backup jupiter
  hosts: localhost
  gather_facts: true
  vars:
    archive_tag: "{{ansible_date_time.date.replace('-','')}}"
    backup_dir: "/u/backups/{{archive_tag}}"
    backup_targets: 
      - /home/camille
      - /etc
      - /home/docker
      - /u/dockerFiles/volumes
  vars_files:
    vault
  tasks:
    - name: Create backup directory
      file:
        path: "{{backup_dir}}"
        state: directory
    - name: Archive files
      become: true
      archive:
        path: "{{item}}"
        exclusion_patterns:
          - '**/*tar.gz'
          - '**/*tgz'
          - '**/*deb'
          - '**/*zip'
          - '**/[0-9]*'
        dest: "{{backup_dir}}/{{item.rsplit('/')[-1]}}-{{archive_tag}}.tgz"
      tags:
        - archiving
      loop:  "{{backup_targets}}"
      register: archive_output
      notify: "notify me"
    - name: Touch the target archive file for joplin db dump
      file:
        path: "{{backup_dir}}/joplin-{{archive_tag}}.sql"
        state: touch
      tags:
        - psql_file
    - name: Dump a database in a docker container
      community.docker.docker_container_exec:
        container: joplin-db
        argv:
          - pg_dump
          - --dbname=joplin
          - --username=joplin
          - --file=/tmp/joplin-{{archive_tag}}.sql
      tags:
        - psqlr_dump
      register: dump_output
      notify: "notify me"
    - name: Copy dump to host
      shell: docker cp joplin-db:/tmp/joplin-{{archive_tag}}.sql {{backup_dir}}
      tags:
        - docker_cp
      register: dockertohost_output
      notify: "notify me"
    - name: Change ownership of archive directory
      become: true
      file:
        path: "{{backup_dir}}"
        owner: "{{ansible_user}}"
        recurse: true
      tags:
        - chowning
    - name: Copy to DO
      with_fileglob: "{{backup_dir}}/*"
      amazon.aws.aws_s3:
        aws_access_key: "{{ vault_do_access_key }}"
        aws_secret_key: "{{ vault_do_secret_key }}"
        s3_url: "https://sfo3.digitaloceanspaces.com"
        region: sfo3
        bucket: "camille-space"
        object: "/jupiter/{{archive_tag}}/{{item | basename}}"
        src: "{{item}}"
        mode: put
        overwrite: no
      tags:
        - s3copy
      register: s3copy_output
      notify: "notify me"
  handlers:
    - name: Telegram notify
      community.general.telegram:
        token: "{{ vault_telegram_bot_id }}"
        api_args:
          chat_id: "{{ vault_telegram_bot_chat }}"
          parse_mode: "plain"
          text: "{{ archive_output }} \n {{dump_output}} \n {{dockertohost_output}} \n {{s3copy_output}}"
          disable_web_page_preview: true
          disable_notification: false
      listen: "notify me"
